using System;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Collections;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Collections.Frozen;
using System.Threading.Tasks;
using System.Diagnostics;

const string INPUT1 = @"???.### 1,1,3
.??..??...?##. 1,1,3
?#?#?#?#?#?#?#? 1,3,1,6
????.#...#... 4,1,1
????.######..#####. 1,6,5
?###???????? 3,2,1";

const string INPUT2 = @"??????#??#?? 1,1,5,1
?#?#??##?#? 2,5,1
????????.?#???#??##? 2,1,2,1,1,6
#???#?????.?#?. 2,1,2,1
?##..?#?#?? 2,4
..#??##????###????#? 6,8
???#..?#?? 1,1,2
.#????#?.??? 3,2
.?#??##?.? 1,3
????????#? 2,1,1
.?##???#?##????.? 7,4,1
?##??.?#.????? 5,1,4
?????.#??#?? 1,1,1,1
?#.???.???.##?#?. 1,1,1,1,5
.#??.??.???.???. 1,1,2,1,2
.?.????.??? 1,1,3
?????#??????????# 6,1,6
#?????#???? 1,8
.???.??#?.#????#?.?? 1,1,1,7,1
.??#????##??#.# 12,1
?#????##.#.?? 2,4,1,2
??.??#?#.#? 1,3,2
??#?.#????#?#? 2,9
#??#????#????? 4,3,1
?##????.???? 3,2
?##??#?.#??#??#??#.? 2,2,10
??#?#??????#.#?#.? 11,3,1
??##.???????#??????. 2,1,2,4,2
????.?#.???#.????.? 1,1,1,4,1,1
???????????#???.#?? 1,10,2,2
#???#???????#???? 1,1,7,1
??.??#?#???.??? 1,5,1,1
?.?.?#..## 2,2
??????.?#??#???.? 4,1,4
???????##?? 3,2
?????????#?.?#?# 8,1,1
???????.#???.?#??. 1,1,2,2,1,3
?#????????????#????? 2,12,2
..?##??#???.???? 8,3
#??.?.????#???????? 1,1,2,1,7
????#?#?##???. 2,6
??#????....#???? 1,5,2,2
.?????#?????? 1,5,4
????..???.???#??##?. 1,1,1,1,1,6
?.??#?...??? 2,3
#?#??????##?# 3,2,2,1
#?##?????????? 10,1
??#?#?#????#???#??? 13,2
?#?.??#???#.?? 3,3,2,1
??????#????????#?? 4,1,5,1
#?????#.?. 3,2
??#?#?##?.???? 1,7,1,1
#?#??#?.##???.???#? 1,5,2,1,4
?????#???#.#??# 1,1,5,2,1
.?#?#...??#?#??#?# 1,1,6,3
???#??#????#?#. 1,9,1
#????#???.? 1,1,1
?#?#??#??.#. 1,1,3,1
..?.???#.????? 1,2,1,2
.??#???#??????#.??.? 7,4
.????????? 2,2
?.??.???.?? 1,1,2
???.?.???#..??. 1,4
.?..?.????#???? 1,1,3,2
??????##??#????.# 1,1,8,1,1
.?#?.#??.??#?#???#? 3,1,1,9
??###??#??????#?#?? 1,6,1,1,1,3
?#??.??#?? 2,1,2
.???#????#??? 4,1
??.#?##??? 1,2,1
?????.???.?#.##?? 4,2,2,2,1
???#???????#.#???.?? 4,1,1,1,3,1
?..????#??##?#? 1,8,1
#???#?##??? 3,1,4
??.???.?##.?..?#? 3,3,1,2
????.??????#? 1,1,3,1
?????#?#?##??. 4,6,1
.?????????# 2,4
??.?.?????#?#. 1,7
.#?#??.??????????? 1,3,7,1
????##?#?##?? 1,2,4
??.??????#?#???. 1,2,5
?#.?#??#????.?? 2,1,1,1,1
???##?.?.???#..?#?#? 1,2,1,1,1,5
.??.#??????#?#### 1,1,1,9
?#?#?.???##????# 1,2,1,3,4
##?#.#??#?? 4,5
????..#??. 3,2
??#????.??##??# 4,1,5
??.???.#???????????? 2,1,6,1,3
???#?.?.????#?????? 4,10
#?????#?????. 1,1,1,5
.?#??.??#???. 2,6
?#.?????#??##???. 1,1,2,1,5
.#?.???????##?.#.. 2,2,3,1
??#??#??.?#????? 1,1,3,3,1
#.????.???.??.????# 1,1,1,2,1,5
??#??.???#?? 5,1,1,1
?##?????????? 5,1
??.??#??.?. 4,1
.?.##????.?.? 1,5,1
.#.?????????.?????? 1,7,1,2
?##?..?????#??##?##? 3,12
#?#?##?#?????#??#??? 1,9,1,1
????#?##???#? 1,8
??.?##?????????.? 1,11
??#???#?#.? 2,2,1
.????#???.???#?#? 1,5,5
????.??.##??? 2,4
?#???.???.#????#?? 1,1,1,1,1,4
??######?#????????. 8,1,1,1
????.?????? 2,3
.???#????? 1,1,1
??????#?#?#??# 10,1
#?#????????? 1,6,1
???.?.?##?#?.????. 1,6,2
?.??????#.#.. 1,1,3,1
???.?????#?.? 1,2,2,1
#..???.?.#?? 1,3,1,3
?#????.#?????#. 2,2,1,2,1
..#?????????..??## 1,1,1,1,1,3
??????????#??#? 1,12
#?#?.?#??????. 4,1,2,1
???#????#?#???..?# 9,4,1
.??????#..?. 1,1,1,1
?.??#????#? 5,1
#?.?.??#?#.?? 1,1,3
?#.????.?? 1,3
#??#??##?#.?..?? 1,6,1,1,2
.???#??????.?#?.? 5,1,1,1,1
.??.?.????? 1,1,2
..?##?????#????? 5,5
?..?#??#?????.? 2,4
???#.#????.# 3,2,1,1
??.??#.?.???? 2,2
????????##??.??.? 7,3,2,1
.???#????????????? 10,2
.?#??.???.???# 3,2,1,1
?##???#.?? 2,2,2
??.??#?.?? 1,4,1
??#?#.??#? 1,3,3
?#??????.?????#??.#? 2,2,1,1,4,1
???????.???.#?.?? 7,2,2,1
.????????#????###?# 1,4,1,3,1
????????#??.?#?..#.? 2,6,2,1,1
?#???.?????#?.????? 2,1,1,3,1,1
???#??.??.. 4,1
.????.?.??. 4,1,2
?????????.#? 1,1,1
?#??#?####??. 9,1
???#??????#?.#?#???? 1,1,3,1,3,1
?#?#???#??#?? 9,1
????#???.?? 3,2
..#??##???.#?. 1,4,2
??.?????.?? 3,2
?#?..???##??.? 1,7
?????#??????#????? 13,1,1
?#??#?##.?.?#???# 1,4,1,2,1
??..??..???.?## 2,1,2,2
??#??.???#????????? 1,1,1,1,8,1
???.?..?#. 3,2
??#??.#.??.#?????? 2,1,1,1,4
##??..?#??? 4,3
?#.?.????.##??#? 1,1,4,2,2
?#???#?????##??? 2,3,5
??#?????.#?##??? 6,1,5
??#?..??????? 3,3,1
?.?.?????###???. 1,10
#????###???#???.?#? 1,6,3,1
?.?#?.???##???##??. 2,10
???.?.#??# 1,2,1
..#????##?#??????? 1,9,1
#?#.????## 1,1,4
???.??#?.#.. 1,1,1,1
?#?.#.?#.?????#? 1,1,1,2,3
?#???.?#????#? 1,1,1,4
???##?????#????##. 1,14
?..??#??..#? 4,1
?????????#??##??. 3,8
?.?.????????#??. 4,2
?#??????#???#????#? 3,5,1,6
?#?#?#?.????#?#??.#? 7,9,1
?#???????#????.?? 6,1,4,2
##.??????.??####.? 2,2,6
##??#...#?? 5,3
????????.#?#?#??? 1,1,4,5,1
.??.?#?.???.??#? 2,2,1,3
???#?#..??#? 5,3
???#?????.?? 4,1,1
?????#.?###??????? 6,6,1
??#???###????#?.?.? 2,8
??#?..###??##???#?. 2,12
???????#?#?#?? 5,2
....?#?.?????###???. 2,1,3
#?????#?#??#?#????? 2,14
??####???#??#??.. 12,1
#?#????#???? 3,6
???#?..????? 1,1,4
?.?##????.???# 4,1,3
?#?##????#???##????? 5,3,5,1
?.?#?#???##? 1,9
.?#???.??##? 4,2
?##?##????.###.?? 8,3,1
??.??????#.?.? 1,6
?..?#?????.. 2,1
.??.????##?#??# 1,9,1
.???#.#.?.??.. 3,1
?????#?????.???#.? 4,1,4,1
???#??#???????#???? 8,5
??#####???#?????.? 10,1,1
???#????#??????#?# 4,11
?????#??#??#??# 1,1,5,1,1
??##????.?.?.??.? 4,1,1,2
???.?.?#.?????????#? 1,1,1,1,8
?#???????.? 4,2,1
??#??#????#..??????? 10,4,2
?.??.??.??. 1,1,1
???.???..#? 1,1,1
???????????.?##?? 4,2,1,5
#.?????????#???#???# 1,11,3,1
???#??.??#? 1,2,3
.?.?#?????????#?.. 3,9
??.???#?.????#. 1,2,5
#??#??.??#?#??? 5,5,1
.???????#?????? 4,1,1,1,1
.#????#?????#?? 1,2,2,1,3
??#?#??.?? 7,1
??????#?.? 2,3
????.#??##???.?? 1,1,5,1,2
.??###????.#?#? 7,3
????.??????..?. 2,1,1,1,1
???#?????##?.?.??. 9,1
???#?#????.?#? 5,1,1
??????????? 5,1
?#???.?.???..#??##?? 1,2,1,2,2,3
.??????.??#?#??? 1,2,6,1
??#?????#??.. 1,2,1,1
??#????????##??## 2,10,2
?#???##???? 2,5,1
..??.#????.???? 2,1,3,2
.?##??#??#.?#? 4,1,2,3
.?#??#????##?.? 6,3,1
??.#.?###?????? 1,1,4,4
?.??#.##?##??#?. 3,5,2
.?.???#.?#??.. 1,1,3
??.??##.?#. 1,2,2
??..??##?#. 1,5
??????????..??? 1,2,3,1
???#?????.? 5,1
?????##.??.??? 1,2,2,2
???.?#??#??? 2,7
?#.?#???.???#??.?#?. 2,1,1,6,3
???.???#.?#?????#?. 4,7
#?##?#?#??#??.? 4,4,2,1
#????#?###??. 1,8
????????..#???? 5,1,1,2
?#???????#.?.#? 6,1,1
??????#?????.#?.#??? 1,6,1,1,1,1
.??#?#??.???????? 5,1,1,1,1
???.?.?#????##?## 1,10
????##?###?#???#? 10,1,2
??.##?.???#???#?#? 3,9
??#??????? 1,1,1
??????.?##??##?# 1,2,7,1
.??####?????????# 7,7
????.#???? 2,3,1
???#????????? 2,1,1,4
?.??#???#??##????#? 1,1,5,5,2
?##????.??.??#?.?. 5,2,2
????????.?# 1,2,2
??#???.???## 1,1,3
..??.##?.#?? 1,3,2
?????????..#??#???# 3,2,4,2
?#???????.? 2,2
#????#????#??????#? 1,1,1,5,1,1
#????.?#?.## 1,1,1,2
?#??#???#?# 8,1
.?##?????.???? 2,1,2
???????#??#?????##.? 1,1,4,2,2,1
.?#.?#.?#?#.???? 1,2,4,1
.?..#???????... 1,7
??..#??#??#.?#???# 1,1,1,1,4,1
?#.??????.?#. 1,1,2,1
?.#??##???.??.#??? 1,2,3,1,1,3
#???#.???#?.???. 2,1,1,2,1
?#??#??????#????##?? 5,1,8
?????#?##???????.?.? 2,12,1
..?#???##?.?#??#???? 2,4,7
??.#??##??#??? 1,1,2,4
???.?#??.???????#? 1,5,1
?.??????..???.???# 6,3,2
?#???.?#.? 1,1,1
.?.?????#?.????## 1,4,2,1,2
#??#???#.???#?.? 8,1,2,1
?.??#?#?#???#???? 11,1
.#..???#??.#? 1,6,1
.###??#??? 3,4
??#??????#????#??? 1,8,4,1
??.??...#?..??..? 1,1,2
#??#???????#????? 8,4
?#?.??#????? 2,1,1,2
?????????..#? 2,1,1,2
?????#?????#?#????. 3,5,1,1,2
.#????#????#?? 1,7
#.#.????????? 1,1,5,1
???#??#?#?#?#????? 1,2,12
?#????.??.?## 2,3,1,2
???#??????..?#. 5,1,1,1
#???###???.?#?#?.? 1,5,1,5,1
?.?.?#?????? 1,7
????#????###.??? 1,2,1,3,1
?..?##???#?.?.??.?? 7,2
?#?#??#.?#????.#.? 3,1,1,3,1,1
.???#?.???#? 2,3
?###???.?##??. 4,4
.#??#???#?#?#??#? 5,1,6
##?##??#??#?????. 13,1
??#??#?.?? 1,4,2
#??##?.??# 1,3,3
??.???.??#???##?? 1,1,8
?.??????#?????..?? 6,1,2,1
?#??.??#.??.??#?#? 4,2,1,5
.???#????# 1,7
#???????#??#??? 3,1,4,1
.??##?????...?#.... 7,2
?.#???#..?.?#?? 2,1,4
#?????#.?.??# 4,1,1,2
?#?#????#????#? 9,2
?????#????.??#?#??? 1,1,1,3,6,1
.??...???.???? 2,1
????#?.#??????? 5,3,1
??????#???????#??# 1,2,3,1,6
?#??.?#??#??.??? 4,3,1,1,1
??..????#??#? 1,8
..#?..?.?. 1,1
?..#?..?..#???#???? 2,1,1,7
?#???????? 2,1,3
?.###????#?##??#.? 11,1
??????#?.. 3,2
.????#????#???#?# 2,8,1,1
?.???.???#.?????#??? 1,1,1,2,9
##??.????##?.?##?. 4,1,4,3
???#.??#??????#???? 3,8,1
?#??#????#.???? 6,2,1,2
#??#????#??#?? 1,10
#?????????#????. 1,1,8
#?.?.#.??????# 2,1,2,3
?#?#???????#... 8,1
???.????.?? 1,2
...???#??# 2,2
??##.????#? 4,1,1
.?#??#??????##?? 1,4,6
??#?????.????? 4,1
?.#.?????#?? 1,2,1,3
.##????#??.?#?? 9,3
?.?#???#??#.?.??.? 1,1,4,1,2
?...?#?#????? 2,2
????.#???????? 1,8
?????#.?.????#??#??? 6,1,1,1,1,1
??#????.???. 3,1,1,3
?.???.?.??#?????? 1,1,1,6,1
#?.?#..?????##?#?#. 1,2,2,8
??##??..??.?. 3,2,1
??????.?##.? 3,3
??????##???????.?? 14,1
??.??????###??.##??# 1,1,2,4,2,1
????#???#??? 4,1,1
#?.#??#?##.??..#???? 2,1,1,2,1,5
??.##???#??# 1,2,3,1
??#?#??.???#?#. 2,2,1,2,1
?#.??????????#?? 2,5,1,1
??.?.????? 1,1,1
..#???.???? 4,1
???????????# 3,1,1
.???##?#??????.?.?#. 2,9,2
????#????#???? 5,7
.??##????.???#?.#??? 8,5,1,1
?..????????##???#??# 1,1,1,2,10
.??###?.??# 5,1,1
???##??.?.??? 7,1
##????##?#? 4,2,1
?#?#??#???####????? 3,12,1
??###??#??.?#. 9,1
.?##?.??#?#????#?? 3,4,3
.?#???#???.?.???. 8,1,2
.?.??#?????#?#???? 1,11,1
?????#??#?? 3,1,2
?.??..????.#. 1,2,2,1
?.????#??????#.#?. 1,1,2,2,3,1
????.?#??#??.#???#.? 1,1,6,3,1
.??#?.???????? 3,5,1
???#????.? 1,1,1
????#??###???#?##?#. 1,1,2,7,2,1
..????#?.?.??????? 5,6
??#??.??.###?#??.?? 3,7
????????????? 1,6
#.?##???#?? 1,4,2
.???????.#?#?#??#?? 2,1,8,1
..?.#.?##.??? 1,1,2,2
?????????#.??? 1,7
?..???#????.#??#??? 4,5
??..???#????.?# 1,5,2,2
.???#????#????????? 7,2,1,1,1
??..???.?#??? 2,1
.###?????..###?###? 6,7
?.#.??.???#???# 1,1,3,1,1
???.?#?????. 2,3,1,1
.?#..???##????.????. 2,8,1
???.#..#???? 1,1,2,1
???#?##?.??#?##.?# 2,4,1,1,2,1
???#????????#?.??# 1,1,1,3,1,1
??##.????##??. 3,2,4
???????#???????###? 12,3
.???.?.?.?##???#?? 1,1,1,7
.?#???..?#?? 2,4
?.????#????## 7,2
.??.?????..??? 4,1
????#??????? 1,4,3
?#?#???.?????????.?? 1,1,6,2
??????#?#?????#????. 8,6,1
#??????..????# 5,4
?#??#?????#??.??##?# 2,9,5
.?????..??? 4,3
????????#???? 1,2,3
????#???#.???####.?? 3,1,3,7,1
?.???..???#?????.? 1,8
?#?#?#??????.??#? 2,6,2,3
?????##.#?. 1,4,1
.#.??????##?#. 1,1,6,1
?#?.????##?#??#???? 1,1,1,4,3,1
??????????..? 3,1,1,1
#.????##??.??????? 1,1,4,2,1
?#????.?????#??##?.. 5,3,7
.??.????#??????# 9,2
???##??.??#??#.?. 4,3,1,1
.????#??.? 1,3
?#??#?????#?##?????? 8,7,1
?????#??#??#.???#?#? 1,5,2,1,4
?#?????#?#?##???? 1,9,1
..???#.???? 2,1,2
??##?#?#????#.? 6,1,3
?#???###?.??#?? 8,4
.##?#?????. 6,2
.?.??##.???#?????? 3,2
.??.??#??.????.?? 4,1
????????..?? 6,1
.?????#?#?#?? 1,9
#?.?##?#?#??? 1,7,1
??#???..?. 3,1
#??.#??????#???. 3,2,5,1
??#???..?##?#??.?? 5,4,2
?...????..????#.??? 4,1
??????#???#?. 1,8
???.?????#?#?#?????? 1,1,1,1,2,8
???.????.??. 2,1,2
?.?.?????? 1,5
.?.????#.? 1,3,1
..?##????#???????## 5,2,2,3
#?????#??.??.#??? 9,1,1,1
?.##???.#? 4,2
?#?.??##?????#.???? 1,1,4,1,1,3
??????.??#??.#. 1,1,2,1,1
?##?#??#..????..??# 5,1,1,1,2
?#?#???#????????. 3,2,5
??????#???##????? 1,11
?#.??##??????.????#? 2,9,5
?##???.?#??.???#? 5,2,4
#?.?#.??##?..? 2,1,4,1
?.?????.#??#???? 1,1,1,1,6
????.??.?## 2,2
??.#??#????# 5,2
??#?.???#??#???? 3,5,1
???..??#?.. 3,1
??#?.????? 1,1
##???.??.??#. 5,1,1
.??????.?#????? 4,2,3
???????.?????? 3,1,1,3
.?.?????##??#??.#??? 1,9,1,2
?????###??? 1,6,1
????.###?? 2,4
.?????###??.??????? 7,3
?.#????#?... 1,2
?.?#?.???#.?????.?? 1,1,4,4,1
??????#??. 1,1,2
.?.???##??? 1,5
??????????#????? 4,1,3,1
?##????#?###????? 12,2
???????#????? 1,1,2,1
???.#.?????.? 1,4
..??#???##? 3,2
??.?????#???????#.# 1,1,3,1,5,1
??.???..?.???? 2,1
???###?..?#??. 4,1
?.???.????? 1,3
#?#?????..??#..???? 5,1,3,2
##??.???## 4,1,2
?????..???.??? 3,2,1
??#?#????.#?##?#. 4,1,6
#.??#.##?#??????? 1,1,1,10
.???##?#?#?????????? 13,2
????.#..?#??#????.. 1,7
?##??..??.?? 4,1
?#?#?????.? 8,1
.#???????????? 3,6,1
???#?#????????#? 12,1
.?#??.####? 2,4
?#???##?..? 1,2
?.??.?.?#???????.?# 1,2,1,6,1,2
??????.?#. 1,1,1
???.?????????.#. 9,1
?#?###??#?#?? 10,1
#.?.?#??#??? 1,1,5,1
???????????#???##. 1,4,5,3
?#.???????????? 1,1,4,1
.????#???.????#?? 7,1
.??????#????#?? 4,2
..???????#?.? 1,4,1
????????## 1,4,2
??.?.?#??.????##??# 1,1,1,1,1,7
#?..??#.???????? 2,3,7
??#?#?#???????? 3,3,1
?..??.?????#? 1,1,7
#.??#???????? 1,10
????..???#??.??? 2,4
????????????.?#? 1,2,1,1,2
???#???.?. 1,2,1
??????????#??? 1,7
???#?##?????? 6,4
??##??.??#?#??.?? 3,6
.?.#?#???..??# 1,3,1,2
???????#?##??????#? 2,5,6
?#..????.???#? 1,4,1,2
.??#?.???#? 4,1,2
?##????.?#??.??# 6,2,2
????#?.???.???#??? 2,3,1,2,1,1
?.?.?###???#.?. 1,5,1
#?#?.??###?#??? 1,1,8
???????????? 1,1,5
??.???#???#? 1,2,1,2
?#?.?.?#??.???#?? 1,4,5
.#??????????##??#??? 1,1,10
???.???.??..?##? 1,1,1,1,3
??.#????#???#????? 1,2,1,1,6,1
????????#??????? 3,3,1,1
#??.#?.???. 2,1,3
?????????.??#?? 1,5,3
??#?.?#?#?.????? 1,2,5,2
.##????##???#? 3,6
.???????.? 1,3
??.#..##???.#?#? 1,1,3,1,1
?.#??#?.?#??# 1,5,4
??##??.?????#??. 3,7
#?#?????#?.#??.###?? 4,1,1,2,4
#?????.????.?##? 3,1,1,1,3
?#??#???.????? 8,3
?.?#??#?..?#?# 5,4
??#?#???#.????.. 9,1
???#??##?##. 1,9
.#..?.##????? 1,1,3
??????..??#? 5,2
.?.?????##??##??? 1,9,1
?????.#??#?#??#?.? 2,9
?????#???#?#?? 4,4
??#.#????.##????#. 2,3,1,2,1
??#?#.??.##??#????# 2,1,2,2,1,2
.?.#?????#??.?????.? 1,3,3,1,2,1
#????????#?? 1,7
#?.??????#..?#??#? 2,1,1,1,1,6
??#.?????#?#?##?. 2,11
.#????#?.?? 2,2,1
??????#?.?#.?#???..# 1,4,2,1,1,1
??##??#.???#. 5,1,1,1
.?#.?#?#?.?#? 1,4,1
????#???##?????#?? 1,1,1,9,1
?.??.????#?#?????? 1,8,3
???#?#??.? 3,1
#?.???.??#???##??? 2,8
?#????#??? 3,2,1
????.?#?.? 1,2,2
??##??.???? 3,1
??????.??.? 2,1,1
???#?#.??.?..?#.?#? 5,1,1,2,2
???.#??###??.?#???.. 6,5
???????#??.?.??? 1,4
????#?.????????# 5,1,1,1,2
????#.???#???.?.??.. 4,1,1,2
??#??#.?##??#.??# 1,1,1,5,3
?#?.#?#?????### 2,3,1,4
..#??..?.??.???#.?? 3,3
...#????#.???#?##?. 1,2,8
??#.#?#??..?..???? 1,1,5,1,2,1
??????##???#?? 7,1
?#??????.#.?#?? 4,1,1,4
??????.?????????. 2,9
??????#??????? 3,4,4
#????#???#???#??? 11,2
?#?.?#?.??????? 2,2,1,1,1
?#????#??#???? 2,7
?#?#????.??? 6,2
??#??????? 3,1
?.#?#????###?#????? 1,1,11,1
?????#??#???##?###? 1,9,3
??#????.??##? 4,1,3
???????#???#? 2,6
??#??#.?.????????? 2,2,1,4,1,1
.##?????#?.? 2,1,2
??##.?.????#?????? 2,10
??##?.??????#?##???? 4,2,5
.???#????##????. 11,1
.?##??????#.. 4,3
##.?#??#????#???? 2,7,5
????#..?#?##??? 2,1,8
..##??.?#?###?#??#. 4,1,8
?.#?.???.???#.?? 1,1,2,2
.#?#????#?.# 1,1,4,1
?##??#??#?.###???#. 6,1,3,2
?#?#.?????????###?? 3,2,1,1,6
?????#???#???.???##? 2,4,2,1,1,3
??##???#?.???. 1,6,1,1
???##.?#????#?????? 1,2,2,3,1,2
????.#???? 2,3
???????.##??????#?. 5,2,5
?###?.???#?? 3,1,2,1
????????????? 1,6,1
##????????.???? 2,1,3,1,1
???#????##?? 6,3
?.???????.?##? 4,2
??#??##??##??#??? 6,7
?####???.?.##??.? 6,3
???.?#.??#? 1,2,2
.?.?#????. 1,1,1
.?#??.#????##??# 1,1,7,1
???.???#???.?#? 2,1,3,1
.????.?..?? 4,1
??#?.#???.?#? 3,4,3
???#????..??? 1,1,1,3
???.???#???.?? 1,6
.#??#???#?????? 2,11
?......#?..?.????.. 2,3
?.#??????#?# 1,1,7
????#?#?#? 1,7
..####.????? 4,3
??#???#..?.??????#?? 1,2,8
?#?????????...??#.?? 2,6,2
??###??????.#???.??? 5,1,1,3,1
???#.???????? 4,1,1,1
?##?????#.?????#??? 9,4
??#?#???.#?#??##??# 1,1,2,3,2,2
?.?.#.?#??????## 1,1,2,7
?????#?##??#.?#?? 8,1,2
..?.?#????#????#?? 1,1,1,1,5
????#??#?###????#.?? 1,5,3,2,1,1
?#?#?#?.#????? 3,1,1,1
?????????#? 2,4,1
?#?????.??#?.?# 1,4,1,1,2
???#???#.???.#??.# 1,2,1,2,3,1
?..#?##????????? 6,2
##???.??#????? 5,4,1
??.?#???????#?#. 1,1,7
?.??#?.#.?#?? 4,1,3
.??????.????? 1,2,1,1
?????#?#?#.?? 5,1,1,2
.??????????? 1,2
.????..#??#.? 3,1,1
??.?#?????#. 2,1,3
#?.?#.???..???.??#?? 1,1,2,3,4
?.??#?#..#??#?? 1,1,1,2,1
#?#????.????? 1,3,1,2
???##???.#? 3,1,2
????.???.???#??????# 2,1,1,4,1,3
?#?.?????##????#? 1,1,1,7
?.#???#?.. 1,3
??##???#.?.??? 8,1,1
??#???#???? 4,2,1
???.?.?.?..???? 2,1
??.??#..#?#??#??#?? 1,1,10
???#??.?????##??#. 1,3,1,7
????##??..?.??? 4,1
?.??.#???#.??? 2,5,2
?.?##????#??. 1,2,5
???????#?.#?# 4,1,1,1
????#?#..?#?? 1,1,1
?????.??.?????#???? 1,2,1,2,7
#???...??????#??? 2,4,2,1
#?????#?????????##. 7,3,5
?..???##????? 1,6
.#??#????#?#?????? 2,1,8
..??.???##?##?#.?? 2,10
??????????????????## 3,2,1,5,1,2
##???#???? 7,1
?.?..?#????.. 1,5
?.?#??????? 1,5,1
????.?#??#..?#? 3,4,2
?????#?????.???#?? 2,5,6
?????###????..???? 7,1,2
???..???????.. 3,7
???#..??#?????.. 2,3
??.???#???? 1,1,1
.#????#??#??. 9,1
???????...??##? 6,4
??????.#??# 5,2,1
?.?????????????## 2,1,1,2,2
?????????#? 2,2
???..?????????? 1,3,2,1
???#?#???#????? 8,1
?#???#??.?? 6,1
?.#???#?.. 1,6
#?.?#?????##?. 1,8
?#?#?#??.??.?.?# 6,1,1,1,1
???????#???###.?? 8,5,1
??#??#????????#?#?? 7,3,4,1
??#?????????.?#. 1,5,1,2
.##???????.?##?? 6,3
????#..#?#? 4,1,2
????????????????.? 7,6
#??#.???.????.???#?. 4,1,1,1,4
.???#???..???##????? 6,1,3,3
???#?...???##? 2,5
.???#.#.#?.?.?#? 3,1,1,1,1
?.??#??.????# 4,1,1
###?#??..#.?????? 6,1,1,1,1
??#?????.????? 6,2
?????..#??#?. 4,1,1
#????#?#?##?.??.#?? 2,8,1,2
.???.?.??#??? 1,4
?#??#????#?#?#??? 2,1,9
.??#??####??..??#?.? 10,2
#???.????? 1,1,1
??????#????.?..# 1,5,1,1,1
??.?#.??.??? 1,1,2,1
?.??..??#?. 2,2
????##.????. 1,3,4
?.???#..??#????. 3,5
.#???.?.#??#????#? 1,1,1,10
?.???.?#?#??? 1,6
.???.??.#? 1,1,1
??#?#???#.??#.?? 7,1,1
..?.#??#?#??#??? 1,2,1,1,3
..?#?.#?#? 3,1,1
?..???????#..##?# 1,1,2,1,4
.#??.?#??###?#?. 3,9
??.??#????##???? 1,12
??????##?#?##???#.? 2,11,1
????.??##??? 2,1,3
.??#.????#?? 3,1
.??#????#???#? 2,5
.??...?#?.? 2,2,1
?#??.?.##??#??#.?..? 2,1,8,1
.##?.???#?????...? 3,6
?.##????###??#?????? 2,6,3,2
?#???#??#??????? 10,2
.????#??##?? 3,1,2
??#??????. 1,1,1
?#???.?????#?#??#?? 2,1,10
#???????#?? 1,2,1
.????????. 2,1,1
#????.??##??#??.??? 1,1,1,8,3
??????#??#???????#? 2,12,1
.?.??#????.? 4,2
.?.????.??##??#.? 1,1,4,2,1
.??#???.##??? 1,4,2,1
??????###??##???.?# 2,5,2,1
??????###??#?.#??? 1,1,7,2,1
.???#???#.???????## 5,1,1,4,2
?.?#.?####???.?#???? 1,7,5
#????.????.#??# 1,2,4,2,1
.??.#??#.#??.? 2,1,1,2
??#.????#? 1,1,1
.#.?.?.??? 1,1,2
??#..?##??. 3,5
?#????#??.????##..? 7,5
.???.??.??.??? 2,2,1,1
?#??.#?#?.?? 3,4
????#?.???.??.#??# 6,2,2,2,1
????.??????.??#. 2,3
##???.?????.#???#. 4,1,1,2,1
??...#???#???#? 1,2,6
???.??#?#.?? 2,1,1,1
?#??#?#????.?? 5,1,3,1
??#??#????????# 6,1,2
???????.????..?#.?? 1,3,2,1
???#?..?????. 4,1
??.??.????#?#.?#.# 1,1,7,1,1
?.???#?????##...?# 1,1,1,1,3,2
???##..??????????#? 3,8
????.????.#?..#? 4,1,2,1
#?..#?#?????.?### 1,3,2,3
???????#??#.?. 1,7
???#?.??#?#??.#?? 4,4,2
??#?###?##?#?????#?? 3,3,11
????#?.??.#??#.? 4,2,4,1
.#???#.?.#?.#. 3,1,1,1
?##.???.???????#?? 2,8
???.??.#???.??. 1,4
.#..??????#?#?##?? 1,1,2,3,2,1
?#.?#???.??.?#??? 2,1,1,1,4
??#??#??#????#.# 1,3,2,2,1
??#?#?##????#??. 6,5
????.?????? 3,1,1
#????##?#??#??#?#?.? 9,2,1,2,1
?.??#?#???? 1,5,1
?.?#.??##??# 1,1,7
.?#????#?#?????#? 5,5,3
.???#?#??????###. 1,1,1,2,3
#??##.?.?.?????#?? 5,1,1,1,1,3
??###?##..#?#??. 6,1,2
.??.???.#???? 2,3
??????##?? 1,4
#?#.#?.#??#?##?????? 1,1,1,1,7,2
#?###?#?????.??.???? 5,2,1,1,3
?????##????.??. 1,5,1
?.?????##??#?. 1,8
?..??.?##?..?#?#.?? 1,1,3,2,1,1
##?##?.?.#?##? 6,4
#?##??.??. 1,3,1
???##???##??#?.???? 3,6
??.??????#..????? 1,1,1,4
????.#?????????? 1,8
#?.?.##.???#??. 1,2,1
??????????.????? 1,1,3,1,3
.??????????.. 2,5
?#??#?????.?#?#? 2,1,1,5
???.#?#??????..?.#? 1,1,5,1,1,1
??????????????.? 1,5
#?#??.?.?#???. 5,1,2
??????.???## 3,1,5
??#??#?#.??#. 7,3
.##???#.???? 2,3,1,2
#?#???#?.##?#?.? 4,1,5,1
.?#????.????#??#. 3,8
??##?#?.#??#???? 1,2,2,1,5
?.?#..##?.?? 1,1,2,1
.?##???..?#? 5,1
??#??#??.#.? 1,4,1
##????#.??#?? 2,1,2
??.??.???#????#.?#.? 1,1,3,2,1,1
???.?#?##???? 1,1,2,1
.???#???????#?? 5,1,2
???.#??##??#??.??#?? 9,4
.??????#.?#??????. 3,3,2
???????##?#?##?. 1,1,6,3
?#.?#??##???##?.. 1,7,3
.???.#???.?#?#?? 1,1,5
.?#??????????? 2,4
.??????????????? 7,1,1
.#.??#???#??. 1,5,1
?#.????..#?#.?..#.# 1,4,3,1,1,1
?????.?#?? 4,1,1
?.??????#?????????# 1,6,3,1
.????????.#??????#?# 2,5,2,4
.?????????????#? 3,4,4
.##..??.?? 2,1,1
??#?#????.?#?#??.?? 7,4,2
??.?.??###.?#? 1,1,5,3
?#??.#??#??.?#??# 3,1,4,2,2
????????#?#????#?# 1,3,1,3,2,1
???#??#??????.??# 1,2,5,1
#??#??#?#??#?.????. 1,3,1,5,2
##?#??.??#??#?? 4,2,1
.#?#??????..#?? 1,1,3,3
?????.????.? 4,1
.??????#?? 2,4
???#??#?#???#?.?# 8,3,1
.??###.????###.??#.? 4,7,1
#??#????????#???#??# 2,2,1,1,7,1
?..?##???#?.?? 4,2
??????#????.#..? 2,3,1,1,1
??#?#?#??##?????.??? 11,1
.?.??????#.?????? 1,3,3,2
?..#.?.??.??##???#? 1,1,2,7
?????#.??#.?#??? 2,3,1,1,1
???##?.#.?.????#???? 1,2,1,1,7,1
.??#?.???. 1,2,1
?????#??#.?....?? 5,1,1
??##??.?#?.????#?##? 1,4,3,1,6
??.????##?.#??. 1,1,3,1,1
?????##?.#.#?## 1,5,1,1,2
?????.?????..?.? 2,1,4,1,1
?#?#??###??.#?#?? 8,4
.#????#??#.?????# 3,5,1,1,1
????##?###?.?#? 1,1,7,1
??#??#??#????.. 1,4,6
?#.???.??. 2,1,1
.?#??##????? 2,7
#??.##..#?..#?? 3,2,1,3
???.?#?#??. 2,4
?.?????#???? 3,2
???.??#???#??##?#??? 1,13
?.#?????#?.#? 4,2,1
#?.???#.????.? 1,2,3
????.#??.??.?#? 2,1,2,1,2
????.?.?#?#??#?# 1,1,1,6,1
..????#?.??? 6,3
.??????????... 5,3
.??#????#???.????? 10,1,2
#?.???#?.??#? 1,4,1,1
??#???###??.???. 9,1
#?##.????.#??#?#???# 1,2,3,8,1
.??#???????#?#??# 1,1,11
?..??.??????# 1,1,7
??.?#??..????..??? 1,2,1,1,1,1
???#??##??????### 1,1,6,3
?#?????###?#???. 2,8
?#?#.????#..??? 4,1,2,1
?.?.?.??#????..#..? 7,1
????.?#?????. 1,6
.??#.???????##??#?? 1,2,7
..????????#?#? 1,2,4
###?.??.????????.? 4,1,3,2,1,1
?.?.??#... 1,1,1
#????#????????? 1,1,3,2,1
.?????#?.? 2,4
?#?#??#?#???..#?#??? 11,1,1
???#?.##??..#??????? 2,3,1,1,4
.#?##???#?.?.? 1,7
#???#???.? 1,4,1
.???..??...?? 2,2,1
???#???????..?. 5,1,1,1
???????.?.#??? 5,4
#.?????.?.#???.?#? 1,1,1,1,3,1
##??##?#????#????.? 2,5,1,1,2,1
??.#???#??#???## 1,13
#?##.??.?#??#? 4,1,1,2
?#???#?##????? 1,1,6,1
#?.???#?#??#???#???# 1,1,1,6,1,1
??#?#???.#?.#????.#? 5,2,2,2,2
#.#?.?##???.#?? 1,2,4,2
.???..??#?#? 2,4
?#????#?????????#? 10,1,2,1
.??..###???#?#? 2,9
?.?????#???????? 4,1
??.???#??.?. 1,5,1
?????#??.?.?#??? 2,3,4
??#.?..??#?#?.?? 2,6
?#?#????#???? 1,1,7
????###???#? 1,3,2
??.#?#?????#?#??? 1,14
?????.?#?????? 2,2,2,3
#??..#?????#?? 3,5,1
?#??#?#????.???#?.? 10,3
#??#.????????????? 4,8
??##?#??#??# 9,1
???#???##?#??? 1,3,4
.?.##?#?????.#? 2,5,1
?..????#???#??????? 1,5,1,1,1,1
????..#????? 1,1,1,1
??##????##?##??## 12,2
??#?###.?????..? 5,3
????.???#?? 1,2
???#?#???.???..#? 9,1,1
?????#.?#..?.? 2,1,2,1
??#?#..?#?? 4,1,1
?.?.#????#?#??????? 1,5
??????#??.?????? 9,3
???.????.???#?#. 1,1,1,1,3
??####???.#???? 1,6,2,1
?#?.?#?.#. 1,2,1
?#??#?#???#????#??#? 13,4
???#???#?#?#??#????? 1,12,1,1
?.???#??#?#? 1,1,6
????.??????#. 1,6
#??..?#?.?. 3,3,1
?#?###?#.? 1,5,1
????###???#??????? 1,10,1
?????.?.?#? 1,1
????#???#??##???# 2,13
#??#??#..??..# 2,4,1,1
??.??.????..??#.? 1,2,1,3,1
#.???#???.????#???# 1,5,1,1,2,1
?#????#?#??? 9,1
????..??#?.???. 1,1,3,1,1
???#.???#?.? 1,4
??#??.???????.# 3,1,2,1,1
.????????????#? 1,9
?#????.#?.?#??? 2,1,1,2,4
.?.?????#?..##.? 1,4,2,1
?#????##.???#? 3,3,1
??.?.?.???.?###??? 1,1,1,1,5,1
.???#???????? 1,2,7
???#.????? 1,1,4
??.#???????? 1,5
??.##??#.??? 1,5,1
???#????#?????????? 12,5
????.?#?.. 2,3
##??#?.????#?????.? 2,1,2,2,2
#..???#???## 1,1,3,2
????????#?#?? 4,4
#?????????????. 1,6,4
??.??##??#??????# 6,4
????#???????? 5,1,1
?#.??#...??? 2,1,1
???#??#?.???. 7,1
??..?#?.?. 1,1,1
?.????####????#??? 9,3,1
?#.???.?#??#????? 1,1,2,7
.???#.?#?.? 1,2
#?#?#???????.? 3,8
?.#????????.?.??.#. 1,7,1,1,1
???????#????.?#. 10,2
??.?????#? 1,5";

const string INPUT3 = @"????????#? 2,1,1";

string GetCacheKey(char[] map, int[] springs, int initialDamage) => $"{new string(map)}_{(springs.Length == 0 ? "[]" : string.Join(',', springs))}_{initialDamage}";

long CheckPossibilities(char[] map, int[] springs, int initialDamage, Dictionary<string, long> cache)
{
    var cacheKey = GetCacheKey(map, springs, initialDamage);

    if (cache.TryGetValue(cacheKey, out var answer)) return answer;

    var springIndex = 0;
    var currentSpring = springIndex < springs.Length ? springs[springIndex] : 0;

    var damage = initialDamage;
    for (var i = 0; i < map.Length; i++)
    {
        switch (map[i])
        {
            case '#':
                if (currentSpring == 0)
                {
                    cache[cacheKey] = 0;
                    return 0;
                }
                damage++;
                if (damage > currentSpring)
                {
                    cache[cacheKey] = 0;
                    return 0;
                }
                break;
            case '.':
                if (damage != 0)
                {
                    if (damage == currentSpring)
                    {
                        springIndex++;
                        currentSpring = springIndex < springs.Length ? springs[springIndex] : 0;
                        damage = 0;
                    }
                    else
                    {
                        cache[cacheKey] = 0;
                        return 0;
                    }
                }
                break;
            case '?':
                var nextSprings = springs[springIndex..];

                var possibility1 = map[i..];
                possibility1[0] = '.';
                var count1 = CheckPossibilities(possibility1, nextSprings, damage, cache);

                var possibility2 = map[i..];
                possibility2[0] = '#';
                var count2 = CheckPossibilities(possibility2, nextSprings, damage, cache);

                cache[cacheKey] = count1 + count2;
                return count1 + count2;
            default:
                cache[cacheKey] = 0;
                return 0;
        }
    }

    if (springIndex == springs.Length)
    {
        cache[cacheKey] = 1;
        return 1;
    }

    if (springIndex == springs.Length - 1 && damage == currentSpring)
    {
        cache[cacheKey] = 1;
        return 1;
    }

    cache[cacheKey] = 0;
    return 0;
}

void Run(string input, int duplicate)
{
    var sw = Stopwatch.StartNew();

    using var sr = new StringReader(input);
    string line;

    var possibilities = 0L;
    var i = 0;
    while ((line = sr.ReadLine()) != null)
    {
        var arr = line.Split(' ');

        var map = string.Join('?', Enumerable.Repeat(arr[0], duplicate)).ToCharArray();
        var springs = string.Join(',', Enumerable.Repeat(arr[1], duplicate))
            .Split(',')
            .Select(int.Parse)
            .ToArray();

        var val = CheckPossibilities(map, springs, 0, new Dictionary<string, long>());

        Console.WriteLine($"Line #{++i}: {val}");

        possibilities += val;
    }

    Console.WriteLine($"Possible arrangements: {possibilities}");

    sw.Stop();
    Console.WriteLine($"============= {sw.ElapsedMilliseconds}ms =============");
}


Console.WriteLine("Part 1:");
Run(INPUT1, 1);
Run(INPUT2, 1);

Console.WriteLine("Part 2:");
Run(INPUT1, 5);
Run(INPUT2, 5);
